language: python
python:
- '3.7'
dist: xenial
cache: pip
jobs:

install:
  - "./.ci/install-requirements.sh"
  - sudo gem install github_changelog_generator

script:
  - "./.ci/build.sh"
  - "./.ci/install.sh"
  - ./.ci/releases.sh
  - source releases.env
  - cd wrappers/python
  - github_changelog_generator -t "${GH_TOKEN}"

before_deploy:
  - git config --local user.name "wirepas-bot"
  - git config --local user.email "opensource@wirepas.com"
  - export TRAVIS_TAG=${TRAVIS_TAG:-build-$(date +'%Y%m%d%H%M%S')-${GH_RELEASE_PYTHON_VERSION}}
  - git tag $TRAVIS_TAG

deploy:
- provider: releases
  api_key: ${GH_TOKEN}
  file_glob: true
  file:
    - "${TRAVIS_BUILD_DIR}/wrappers/python/dist/*"
    - "${TRAVIS_BUILD_DIR}/wrappers/python/CHANGELOG.md"
  skip_cleanup: true
  draft: ${GH_RELEASE_DRAFT} = true
  name: ${GH_RELEASE_NAME}
  body: ${GH_RELEASE_BODY}
  on:
    branch:
      except:
        - /^build-(.*?)/
#    tags: true
#    branch: master

- provider: pypi
  user: Wirepas
  server: https://test.pypi.org/legacy/
  password: ${PYPI_TEST_PWD}
  skip_existing: true
  skip_cleanup: true
  on:
    tags: true
    branch: master

- provider: pypi
  user: Wirepas
  server: https://test.pypi.org/legacy/
  password: ${PYPI_PWD}
  skip_existing: true
  skip_cleanup: true
  on:
    tags: true
    branch: master

